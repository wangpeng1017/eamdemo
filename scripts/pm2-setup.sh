#!/bin/bash
###############################################################################
# PM2 è‡ªå¯åŠ¨é…ç½®è„šæœ¬
# åŠŸèƒ½ï¼šé…ç½® PM2 å¼€æœºè‡ªå¯åŠ¨ï¼Œå¹¶ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
# ç”¨æ³•ï¼š./scripts/pm2-setup.sh
###############################################################################

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "======================================"
echo "  PM2 è‡ªå¯åŠ¨é…ç½®è„šæœ¬"
echo "======================================"
echo ""

# 1. æ£€æŸ¥ PM2 æ˜¯å¦å®‰è£…
if ! command -v pm2 &> /dev/null; then
  echo "âŒ PM2 æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
  npm install -g pm2
  echo "âœ… PM2 å®‰è£…å®Œæˆ"
else
  echo "âœ… PM2 å·²å®‰è£… (ç‰ˆæœ¬: $(pm2 -v))"
fi

# 2. ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
echo ""
echo "ğŸ“‹ ä¿å­˜å½“å‰ PM2 è¿›ç¨‹åˆ—è¡¨..."
pm2 save
echo "âœ… è¿›ç¨‹åˆ—è¡¨å·²ä¿å­˜åˆ° ~/.pm2/dump.pm2"

# 3. é…ç½®å¼€æœºè‡ªå¯åŠ¨
echo ""
echo "âš™ï¸  é…ç½® PM2 å¼€æœºè‡ªå¯åŠ¨..."
pm2 startup | tail -1 > /tmp/pm2-startup-cmd.sh

if [ -f /tmp/pm2-startup-cmd.sh ]; then
  echo "ğŸ“ ç”Ÿæˆçš„å¯åŠ¨å‘½ä»¤ï¼š"
  cat /tmp/pm2-startup-cmd.sh
  echo ""
  echo "âš ï¸  è¯·æ‰‹åŠ¨æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼ˆéœ€è¦ sudo æƒé™ï¼‰ï¼š"
  echo ""
  echo "   $(cat /tmp/pm2-startup-cmd.sh)"
  echo ""
fi

# 4. æ˜¾ç¤ºå½“å‰è¿›ç¨‹çŠ¶æ€
echo ""
echo "ğŸ“Š å½“å‰ PM2 è¿›ç¨‹çŠ¶æ€ï¼š"
pm2 status

echo ""
echo "======================================"
echo "  é…ç½®å®Œæˆï¼"
echo "======================================"
echo ""
echo "åç»­æ“ä½œï¼š"
echo "  1. æ‰‹åŠ¨æ‰§è¡Œä¸Šè¿° sudo å‘½ä»¤ä»¥å¯ç”¨å¼€æœºè‡ªå¯"
echo "  2. é‡å¯ç”µè„‘éªŒè¯è‡ªå¯åŠ¨æ˜¯å¦ç”Ÿæ•ˆ"
echo "  3. ä½¿ç”¨ 'pm2 status' æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€"
echo ""
echo "å¸¸ç”¨å‘½ä»¤ï¼š"
echo "  pm2 status          # æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€"
echo "  pm2 logs lims-next  # æŸ¥çœ‹æ—¥å¿—"
echo "  pm2 restart lims-next  # é‡å¯æœåŠ¡"
echo "  pm2 stop lims-next  # åœæ­¢æœåŠ¡"
echo "  pm2 monit           # å®æ—¶ç›‘æ§"
echo ""
