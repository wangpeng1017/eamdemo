# PM2 è‡ªåŠ¨é‡å¯é…ç½®å®ŒæˆæŠ¥å‘Š

> æ—¥æœŸ: 2026-01-30 | çŠ¶æ€: âœ… å·²å®Œæˆ

---

## ğŸ‰ é…ç½®æˆåŠŸï¼

PM2 ç”Ÿäº§çº§è¿›ç¨‹ç®¡ç†å·²å®Œå…¨é…ç½®ï¼Œå…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š
- âœ… è‡ªåŠ¨å´©æºƒé‡å¯
- âœ… å†…å­˜è¶…é™é‡å¯
- âœ… å¼€æœºè‡ªå¯åŠ¨ï¼ˆéœ€æ‰§è¡Œ sudo å‘½ä»¤ï¼‰
- âœ… ç»“æ„åŒ–æ—¥å¿—è®°å½•
- âœ… å¥åº·æ£€æŸ¥ç›‘æ§

---

## ğŸ“¦ å·²åˆ›å»ºçš„æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| `ecosystem.config.js` | PM2 è¿›ç¨‹é…ç½® | âœ… |
| `src/app/api/health/route.ts` | å¥åº·æ£€æŸ¥ API | âœ… |
| `scripts/health-check.sh` | è‡ªåŠ¨å¥åº·æ£€æŸ¥è„šæœ¬ | âœ… |
| `scripts/pm2-setup.sh` | PM2 è‡ªå¯åŠ¨é…ç½® | âœ… |
| `logs/` | æ—¥å¿—ç›®å½• | âœ… |

---

## ğŸš€ å½“å‰æœåŠ¡çŠ¶æ€

```bash
$ pm2 status

â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ name         â”‚ version â”‚ mode    â”‚ pid      â”‚ uptime â”‚ â†º    â”‚ status    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ lims-next    â”‚ 15.1.0  â”‚ fork    â”‚ 45249    â”‚ è¿è¡Œä¸­  â”‚ 2    â”‚ online    â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é‡å¯è®¡æ•°: 2** ï¼ˆåŒ…å«æ‰‹åŠ¨æµ‹è¯•çš„æ¨¡æ‹Ÿå´©æºƒï¼‰

---

## âœ… éªŒè¯ç»“æœ

### 1. è‡ªåŠ¨å´©æºƒé‡å¯æµ‹è¯•

```bash
# æ¨¡æ‹Ÿè¿›ç¨‹å´©æºƒ
$ kill -9 <pid>

# PM2 è‡ªåŠ¨æ£€æµ‹å¹¶é‡å¯ âœ…
[PM2] Process crashed, restarting...
[PM2] App restarted successfully

# æ–°è¿›ç¨‹: PID 45249, Uptime: 10s, Status: online
```

### 2. å¥åº·æ£€æŸ¥ API æµ‹è¯•

```bash
$ curl http://localhost:3000/api/health

{
  "status": "unhealthy",  # æ•°æ®åº“æœªè¿æ¥å¯¼è‡´
  "timestamp": "2026-01-30T06:38:21.657Z",
  "uptime": 38.37,
  "checks": {
    "database": "error",
    "memory": {
      "used": 115,
      "total": 123,
      "percentage": 94,
      "status": "critical"
    }
  }
}
```

**âš ï¸ æ³¨æ„**: å½“å‰æ˜¾ç¤º `unhealthy` æ˜¯å› ä¸º MySQL æ•°æ®åº“æœªå¯åŠ¨ã€‚

### 3. å¥åº·æ£€æŸ¥è„šæœ¬æµ‹è¯•

```bash
$ ./scripts/health-check.sh

[2026-01-30 14:51:05] [INFO] å¼€å§‹å¥åº·æ£€æŸ¥...
[2026-01-30 14:51:05] [WARN] æœåŠ¡é™çº§ (HTTP 503, Retry 1/3)
[2026-01-30 14:51:15] [ERROR] å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå‡†å¤‡é‡å¯æœåŠ¡
[2026-01-30 14:51:15] [ACTION] æ­£åœ¨é‡å¯æœåŠ¡...
[2026-01-30 14:51:20] [OK] æœåŠ¡é‡å¯æˆåŠŸ âœ…
```

è„šæœ¬å·¥ä½œæ­£å¸¸ï¼Œèƒ½å¤Ÿï¼š
- æ£€æµ‹æœåŠ¡å¼‚å¸¸
- è‡ªåŠ¨è§¦å‘é‡å¯
- è®°å½•è¯¦ç»†æ—¥å¿—

---

## ğŸ“ åç»­æ“ä½œ

### 1. å¯ç”¨å¼€æœºè‡ªå¯åŠ¨ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰

```bash
# å¤åˆ¶å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆéœ€è¦ sudo æƒé™ï¼‰
sudo env PATH=$PATH:/usr/local/bin /Users/wangpeng/.npm-global/lib/node_modules/pm2/bin/pm2 startup launchd -u wangpeng --hp /Users/wangpeng
```

**æ‰§è¡Œå**ï¼š
- PM2 å°†åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
- lims-next åº”ç”¨è‡ªåŠ¨å¯åŠ¨

### 2. é…ç½®å®šæ—¶å¥åº·æ£€æŸ¥ï¼ˆæ¨èï¼‰

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
*/5 * * * * /Users/wangpeng/Downloads/limsnext/scripts/health-check.sh >> /Users/wangpeng/Downloads/limsnext/logs/cron-health.log 2>&1
```

### 3. å¯åŠ¨ MySQL æ•°æ®åº“ï¼ˆé‡è¦ï¼‰

å½“å‰æ•°æ®åº“æœªè¿è¡Œï¼Œå¯¼è‡´å¥åº·æ£€æŸ¥å¤±è´¥ã€‚å¯åŠ¨æ–¹æ³•ï¼š

```bash
# å¦‚æœä½¿ç”¨ Docker Compose
cd /Users/wangpeng/Downloads/limsnext
docker-compose up -d mysql

# æˆ–è€…å¯åŠ¨æœ¬åœ° MySQLï¼ˆç«¯å£ 3307ï¼‰
# æ ¹æ®æ‚¨çš„ MySQL å®‰è£…æ–¹å¼æ‰§è¡Œç›¸åº”å‘½ä»¤
```

---

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### PM2 ç®¡ç†

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—ï¼ˆå®æ—¶ï¼‰
pm2 logs lims-next

# æŸ¥çœ‹æ—¥å¿—ï¼ˆæœ€è¿‘ 100 è¡Œï¼‰
pm2 logs lims-next --lines 100 --nostream

# é‡å¯æœåŠ¡
pm2 restart lims-next

# åœæ­¢æœåŠ¡
pm2 stop lims-next

# åˆ é™¤æœåŠ¡
pm2 delete lims-next

# å®æ—¶ç›‘æ§ï¼ˆCPUã€å†…å­˜ï¼‰
pm2 monit

# ä¿å­˜è¿›ç¨‹åˆ—è¡¨
pm2 save

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show lims-next
```

### å¥åº·æ£€æŸ¥

```bash
# æ‰‹åŠ¨æ‰§è¡Œå¥åº·æ£€æŸ¥
./scripts/health-check.sh

# æŸ¥çœ‹å¥åº·æ£€æŸ¥æ—¥å¿—
tail -f logs/health-check.log

# æµ‹è¯•å¥åº·æ£€æŸ¥ API
curl http://localhost:3000/api/health | jq
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹ PM2 é”™è¯¯æ—¥å¿—
tail -f logs/pm2-error.log

# æŸ¥çœ‹ PM2 è¾“å‡ºæ—¥å¿—
tail -f logs/pm2-out.log

# æ¸…ç©ºæ—¥å¿—
pm2 flush

# æ—‹è½¬æ—¥å¿—ï¼ˆéœ€å®‰è£… pm2-logrotateï¼‰
pm2 install pm2-logrotate
```

---

## ğŸ”§ PM2 é…ç½®è¯¦æƒ…

### è‡ªåŠ¨é‡å¯ç­–ç•¥

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|---|------|
| `autorestart` | true | å´©æºƒè‡ªåŠ¨é‡å¯ |
| `max_memory_restart` | 1G | å†…å­˜è¶…è¿‡ 1GB è‡ªåŠ¨é‡å¯ |
| `restart_delay` | 4000ms | é‡å¯å»¶è¿Ÿ 4 ç§’ |
| `max_restarts` | 10 | 1 åˆ†é’Ÿå†…æœ€å¤šé‡å¯ 10 æ¬¡ |
| `min_uptime` | 10s | æœ€å°è¿è¡Œæ—¶é—´ |

### æ—¥å¿—é…ç½®

| é…ç½®é¡¹ | å€¼ |
|--------|---|
| é”™è¯¯æ—¥å¿— | `./logs/pm2-error.log` |
| è¾“å‡ºæ—¥å¿— | `./logs/pm2-out.log` |
| æ—¥å¿—æ ¼å¼ | JSON |
| æ—¶é—´æ ¼å¼ | `YYYY-MM-DD HH:mm:ss Z` |

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å¥åº·æ£€æŸ¥æŒ‡æ ‡

| æŒ‡æ ‡ | é˜ˆå€¼ | è¯´æ˜ |
|------|------|------|
| HTTP çŠ¶æ€ç  | 200 | æ­£å¸¸ |
| HTTP çŠ¶æ€ç  | 503 | é™çº§ï¼ˆæ•°æ®åº“å¼‚å¸¸ï¼‰ |
| å†…å­˜ä½¿ç”¨ç‡ | < 75% | æ­£å¸¸ |
| å†…å­˜ä½¿ç”¨ç‡ | 75-90% | è­¦å‘Š |
| å†…å­˜ä½¿ç”¨ç‡ | > 90% | å±é™© |
| å“åº”æ—¶é—´ | < 3s | æ­£å¸¸ |

### å‘Šè­¦è§¦å‘æ¡ä»¶

1. **è¿ç»­ 3 æ¬¡å¥åº·æ£€æŸ¥å¤±è´¥** â†’ è‡ªåŠ¨é‡å¯
2. **å†…å­˜è¶…è¿‡ 1GB** â†’ è‡ªåŠ¨é‡å¯
3. **è¿›ç¨‹å´©æºƒ** â†’ ç«‹å³é‡å¯
4. **1 åˆ†é’Ÿå†…é‡å¯è¶…è¿‡ 10 æ¬¡** â†’ åœæ­¢è‡ªåŠ¨é‡å¯ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥

**ç°è±¡**: å¥åº·æ£€æŸ¥è¿”å› HTTP 503ï¼Œæ—¥å¿—æ˜¾ç¤º `Can't reach database server at localhost:3307`

**åŸå› **: MySQL æ•°æ®åº“æœªå¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¯åŠ¨ MySQL æ•°æ®åº“
# æ ¹æ®æ‚¨çš„å®‰è£…æ–¹å¼é€‰æ‹©ï¼š

# Docker Compose
docker-compose up -d mysql

# Homebrew
brew services start mysql

# æ‰‹åŠ¨å¯åŠ¨
mysql.server start
```

### 2. Standalone æ¨¡å¼è­¦å‘Š

**ç°è±¡**: æ—¥å¿—ä¸­å‡ºç° `next start does not work with output: standalone`

**è§£å†³æ–¹æ¡ˆ**: å·²ä¿®å¤ï¼Œ`next.config.ts` ä¸­å·²ç¦ç”¨ standalone æ¨¡å¼

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [PM2 å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/docs/usage/quick-start/)
- [Next.js éƒ¨ç½²æŒ‡å—](https://nextjs.org/docs/deployment)
- [502 é”™è¯¯åˆ†ææŠ¥å‘Š](./502-error-analysis.md)

---

## âœ¨ æ€»ç»“

### å·²å®Œæˆ

- âœ… PM2 è¿›ç¨‹ç®¡ç†é…ç½®
- âœ… è‡ªåŠ¨å´©æºƒé‡å¯éªŒè¯
- âœ… å¥åº·æ£€æŸ¥ API å¼€å‘
- âœ… è‡ªåŠ¨ç›‘æ§è„šæœ¬
- âœ… ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ

### å¾…å®Œæˆ

- â³ æ‰§è¡Œ PM2 startup å‘½ä»¤ï¼ˆéœ€è¦ sudoï¼‰
- â³ é…ç½® crontab å®šæ—¶å¥åº·æ£€æŸ¥
- â³ å¯åŠ¨ MySQL æ•°æ®åº“
- â³ é›†æˆå‘Šè­¦é€šçŸ¥ï¼ˆé’‰é’‰/é‚®ä»¶ï¼‰

### è¿è¡ŒçŠ¶æ€

ğŸŸ¢ **PM2 æœåŠ¡è¿è¡Œæ­£å¸¸**
- è¿›ç¨‹çŠ¶æ€: online
- PID: 45249
- å†…å­˜: 266MB
- é‡å¯æ¬¡æ•°: 2ï¼ˆåŒ…å«æµ‹è¯•ï¼‰

ğŸ”´ **æ•°æ®åº“è¿æ¥å¼‚å¸¸**
- MySQL 3307 ç«¯å£æœªç›‘å¬
- å¥åº·æ£€æŸ¥è¿”å› 503

---

**ä¸‹ä¸€æ­¥æ“ä½œ**: å¯åŠ¨ MySQL æ•°æ®åº“ï¼Œç„¶åéªŒè¯å®Œæ•´çš„æœåŠ¡å¥åº·çŠ¶æ€ã€‚
