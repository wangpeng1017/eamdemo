# LIMS-Next 部署文档 - 阿里云

> 最后更新: 2026-01-09 | 适用于 Claude Code 自动化部署

---

## 一、服务器信息

| 项目 | 值 |
|------|-----|
| 服务器IP | 8.130.182.148 |
| 操作系统 | CentOS / AlmaLinux |
| 用户名 | root |
| 密码 | xx198910170014Z |
| 项目路径 | /root/lims-next |
| 服务端口 | 3001 |
| PM2进程名 | lims-next |

---

## 二、环境要求

| 软件 | 版本要求 | 检查命令 |
|------|----------|----------|
| Node.js | >= 18.x | `node -v` |
| npm | >= 9.x | `npm -v` |
| PM2 | >= 5.x | `pm2 -v` |
| Git | >= 2.x | `git --version` |

---

## 三、快速部署（推荐）

### 方式一：本地构建 + 上传（最快）

在本地机器执行，利用本地 CPU 构建，只上传 18MB 压缩包：

```bash
# 1. 进入项目目录
cd /Users/wangpeng/Downloads/limsnext

# 2. 执行快速部署脚本
./deploy-fast.sh
```

**脚本执行流程**：
1. 本地执行 `npm run build`（生成 standalone）
2. 打包 `.next/standalone` + `.next/static`（约 18MB）
3. 上传到服务器
4. 服务器解压并重启 PM2

**预计耗时**：1-2 分钟

---

### 方式二：服务器直接部署

SSH 到服务器执行（适用于服务器 CPU 较强或无法本地构建时）：

```bash
# 1. SSH 连接服务器
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148

# 2. 进入项目目录
cd /root/lims-next

# 3. 拉取最新代码
git pull

# 4. 安装依赖（仅 package.json 变更时需要）
npm install

# 5. 同步数据库
npx prisma db push

# 6. 构建项目
npm run build

# 7. 重启服务
pm2 restart lims-next
```

**预计耗时**：5-10 分钟

---

## 四、首次部署（全新服务器）

### 4.1 安装 Node.js

```bash
# 使用 nvm 安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

### 4.2 安装 PM2

```bash
npm install -g pm2
```

### 4.3 克隆项目

```bash
cd /root
git clone https://github.com/wangpeng1017/0105LIMENEXT.git lims-next
cd lims-next
```

### 4.4 配置环境变量

```bash
cat > .env << 'EOF'
DATABASE_URL="postgresql://用户名:密码@数据库地址:5432/数据库名"
NEXTAUTH_SECRET="your-secret-key-here"
NEXTAUTH_URL="http://8.130.182.148:3001"
EOF
```

### 4.5 安装依赖并构建

```bash
npm install
npx prisma generate
npx prisma db push
npm run build
```

### 4.6 启动服务

```bash
# 使用 standalone 模式启动
cd .next/standalone
pm2 start server.js --name lims-next -- -p 3001

# 保存 PM2 配置
pm2 save
pm2 startup
```

---

## 五、Claude Code 自动化部署命令

### 快速部署（代码已提交到 GitHub）

```bash
# 本地构建并部署
cd /Users/wangpeng/Downloads/limsnext && ./deploy-fast.sh
```

### 完整部署（包含代码提交）

```bash
# 1. 提交代码
cd /Users/wangpeng/Downloads/limsnext
git add -A
git commit -m "feat: 功能描述"
git push origin master

# 2. 部署
./deploy-fast.sh
```

### 仅重启服务

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 restart lims-next"
```

### 查看日志

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 logs lims-next --lines 50"
```

### 查看服务状态

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 status"
```

---

## 六、数据库操作

### 同步 Schema（开发环境）

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "cd /root/lims-next && npx prisma db push"
```

### 执行 Seed（初始化数据）

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "cd /root/lims-next && npm run db:seed"
```

---

## 七、故障排查

### 服务无法启动

```bash
# 查看错误日志
pm2 logs lims-next --err --lines 100

# 检查端口占用
netstat -tlnp | grep 3001

# 重新启动
pm2 delete lims-next
cd /root/lims-next/.next/standalone
pm2 start server.js --name lims-next -- -p 3001
```

### 数据库连接失败

```bash
# 检查环境变量
cat /root/lims-next/.env

# 测试数据库连接
cd /root/lims-next && npx prisma db pull
```

### 构建失败

```bash
# 清理缓存重新构建
rm -rf .next node_modules
npm install
npm run build
```

---

## 八、防火墙配置

```bash
# 开放 3001 端口
firewall-cmd --permanent --add-port=3001/tcp
firewall-cmd --reload

# 或使用 iptables
iptables -A INPUT -p tcp --dport 3001 -j ACCEPT
```

---

## 九、Nginx 反向代理（可选）

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## 十、访问地址

- **HTTP**: http://8.130.182.148:3001
- **默认账号**: admin
- **默认密码**: admin123
