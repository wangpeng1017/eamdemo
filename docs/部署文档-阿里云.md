# LIMS-Next éƒ¨ç½²æ–‡æ¡£ - é˜¿é‡Œäº‘

> æœ€åæ›´æ–°: 2026-01-09 | é€‚ç”¨äº Claude Code è‡ªåŠ¨åŒ–éƒ¨ç½²

---

## ä¸€ã€æœåŠ¡å™¨ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| æœåŠ¡å™¨IP | 8.130.182.148 |
| æ“ä½œç³»ç»Ÿ | CentOS / AlmaLinux |
| ç”¨æˆ·å | root |
| å¯†ç  | xx198910170014Z |
| é¡¹ç›®è·¯å¾„ | /root/lims-next |
| æœåŠ¡ç«¯å£ | 3001 |
| PM2è¿›ç¨‹å | lims-next |

---

## äºŒã€ç¯å¢ƒè¦æ±‚

| è½¯ä»¶ | ç‰ˆæœ¬è¦æ±‚ | æ£€æŸ¥å‘½ä»¤ |
|------|----------|----------|
| Node.js | >= 18.x | `node -v` |
| npm | >= 9.x | `npm -v` |
| PM2 | >= 5.x | `pm2 -v` |
| Git | >= 2.x | `git --version` |

---

## ä¸‰ã€å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰

> âš ï¸ **ğŸ”´ æ¯æ¬¡éƒ¨ç½²åå¿…é¡»æ£€æŸ¥ï¼ï¼ï¼å·²å‡ºç°100+æ¬¡é”™è¯¯ï¼ğŸ”´**
>
> **ChunkLoadError 404 é”™è¯¯æ£€æŸ¥æ¸…å•ï¼ˆå¼ºåˆ¶æ‰§è¡Œï¼‰**ï¼š
>
> ```bash
> # éƒ¨ç½²åç«‹å³æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
> sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "ls -la /root/lims-next/.next/static/chunks/ | head -5"
> # âœ… å¿…é¡»çœ‹åˆ°å¤§é‡ .js æ–‡ä»¶ï¼ˆ100+ ä¸ªï¼‰
> # âŒ å¦‚æœæç¤º "No such file or directory"ï¼Œç«‹å³æ‰§è¡Œä¿®å¤å‘½ä»¤ï¼š
> #    cd .next && tar -czf static.tar.gz static && cd ..
> #    sshpass -p 'xx198910170014Z' scp .next/static.tar.gz root@8.130.182.148:/root/lims-next/
> #    sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "cd /root/lims-next && tar -xzf static.tar.gz && mv static .next/ && pm2 restart lims-next"
> ```
>
> **æ ¹æœ¬åŸå› **ï¼š`.next/static/` ç›®å½•å®¹æ˜“åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œå¯¼è‡´æµè§ˆå™¨æ— æ³•åŠ è½½ chunk æ–‡ä»¶ã€‚
>
> **æ°¸ä¹…è§£å†³**ï¼šæ¯æ¬¡éƒ¨ç½²å¿…é¡»ç¡®ä¿3ä¸ªæ–‡ä»¶éƒ½ä¸Šä¼ ï¼š
> 1. âœ… standalone.tar.gzï¼ˆæœåŠ¡å™¨ä»£ç ï¼‰
> 2. âœ… static.tar.gzï¼ˆå®¢æˆ·ç«¯chunkæ–‡ä»¶ï¼‰ â† **æœ€å®¹æ˜“é—æ¼ï¼**
> 3. âœ… public.tar.gzï¼ˆé™æ€èµ„æºï¼‰

### æ–¹å¼ä¸€ï¼šæœ¬åœ°æ„å»º + ä¸Šä¼ ï¼ˆæœ€å¿«ï¼‰

åœ¨æœ¬åœ°æœºå™¨æ‰§è¡Œï¼Œåˆ©ç”¨æœ¬åœ° CPU æ„å»ºï¼Œåªä¸Šä¼  18MB å‹ç¼©åŒ…ï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/wangpeng/Downloads/limsnext

# 2. æ‰§è¡Œå¿«é€Ÿéƒ¨ç½²è„šæœ¬
./deploy-fast.sh
```

**è„šæœ¬æ‰§è¡Œæµç¨‹**ï¼š
1. æœ¬åœ°æ‰§è¡Œ `npm run build`ï¼ˆç”Ÿæˆ standaloneï¼‰
2. æ‰“åŒ… `.next/standalone` + `.next/static` + `public`ï¼ˆå…±çº¦ 26MBï¼‰
3. ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆstandalone.tar.gzã€public.tar.gzã€prisma/schema.prismaã€scripts/ï¼‰
4. æœåŠ¡å™¨è§£å‹ã€ç”Ÿæˆ Prisma Clientã€æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€**åŒæ­¥èœå•æƒé™æ ‘**
5. é‡å¯ PM2 æœåŠ¡

> âš ï¸ **é‡è¦**ï¼šå¿…é¡»æ‰“åŒ…å¹¶ä¸Šä¼ ä¸‰ä¸ªç›®å½•ï¼š
> - `.next/standalone` - æœåŠ¡å™¨ç«¯ä»£ç 
> - `.next/static` - å®¢æˆ·ç«¯ JS/CSS chunk æ–‡ä»¶ï¼ˆ**æœ€å®¹æ˜“é—æ¼ï¼**ï¼‰
> - `public` - å…¬å…±é™æ€èµ„æº
>
> ç¼ºå°‘ `.next/static` ä¼šå¯¼è‡´ ChunkLoadError 404 é”™è¯¯

**é¢„è®¡è€—æ—¶**ï¼š1-2 åˆ†é’Ÿ

**ç½‘ç»œä¸ç¨³å®šæ—¶çš„ä¸Šä¼ ç­–ç•¥**ï¼š

å¦‚æœä½¿ç”¨ scp ä¸Šä¼ æ—¶é‡åˆ°è¿æ¥æ–­å¼€ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š

**æ–¹æ³•1ï¼šä½¿ç”¨ rsyncï¼ˆæ¨èï¼‰**
```bash
# rsync æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œå‹ç¼©ä¼ è¾“
rsync -avz --timeout=300 --progress \
  -e "sshpass -p 'xx198910170014Z' ssh -o ServerAliveInterval=5 -o ServerAliveCountMax=60" \
  .next/standalone.tar.gz root@8.130.182.148:/root/lims-next/
```

**æ–¹æ³•2ï¼šåˆ†å—ä¸Šä¼ **
```bash
# å°†å¤§æ–‡ä»¶åˆ†å‰²æˆ10Mçš„å°å—
split -b 10M .next/standalone.tar.gz standalone.tar.gz.part

# é€ä¸ªä¸Šä¼ å°å—
for part in standalone.tar.gz.part*; do
  sshpass -p 'xx198910170014Z' scp -o ServerAliveInterval=10 "$part" root@8.130.182.148:/root/lims-next/
done

# åœ¨æœåŠ¡å™¨ä¸Šåˆå¹¶
ssh root@8.130.182.148 "cd /root/lims-next && cat standalone.tar.gz.part* > standalone.tar.gz && rm standalone.tar.gz.part*"
```

**æ–¹æ³•3ï¼šä½¿ç”¨æ›´é«˜å‹ç¼©ç‡å‡å°‘æ–‡ä»¶å¤§å°**
```bash
# ä½¿ç”¨ xz å‹ç¼©ï¼ˆå‹ç¼©ç‡æ›´é«˜ä½†é€Ÿåº¦è¾ƒæ…¢ï¼‰
cd .next && tar -cJf standalone.tar.xz standalone && cd ..
# ä¸Šä¼ ååœ¨æœåŠ¡å™¨è§£å‹ï¼štar -xJf standalone.tar.xz
```

---

### æ–¹å¼äºŒï¼šæœåŠ¡å™¨ç›´æ¥éƒ¨ç½²

SSH åˆ°æœåŠ¡å™¨æ‰§è¡Œï¼ˆé€‚ç”¨äºæœåŠ¡å™¨ CPU è¾ƒå¼ºæˆ–æ— æ³•æœ¬åœ°æ„å»ºæ—¶ï¼‰ï¼š

```bash
# 1. SSH è¿æ¥æœåŠ¡å™¨
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/lims-next

# 3. æ‹‰å–æœ€æ–°ä»£ç 
git pull

# 4. å®‰è£…ä¾èµ–ï¼ˆä»… package.json å˜æ›´æ—¶éœ€è¦ï¼‰
npm install

# 5. åŒæ­¥æ•°æ®åº“
npx prisma db push

# 6. æ„å»ºé¡¹ç›®
npm run build

# 7. é‡å¯æœåŠ¡
pm2 restart lims-next
```

**é¢„è®¡è€—æ—¶**ï¼š5-10 åˆ†é’Ÿ

---

## å››ã€é¦–æ¬¡éƒ¨ç½²ï¼ˆå…¨æ–°æœåŠ¡å™¨ï¼‰

### 4.1 å®‰è£… Node.js

```bash
# ä½¿ç”¨ nvm å®‰è£…
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

### 4.2 å®‰è£… PM2

```bash
npm install -g pm2
```

### 4.3 å…‹éš†é¡¹ç›®

```bash
cd /root
git clone https://github.com/wangpeng1017/0105LIMENEXT.git lims-next
cd lims-next
```

### 4.4 é…ç½®ç¯å¢ƒå˜é‡

```bash
cat > .env << 'EOF'
DATABASE_URL="postgresql://ç”¨æˆ·å:å¯†ç @æ•°æ®åº“åœ°å€:5432/æ•°æ®åº“å"
NEXTAUTH_SECRET="your-secret-key-here"
NEXTAUTH_URL="http://8.130.182.148:3001"
EOF
```

### 4.5 å®‰è£…ä¾èµ–å¹¶æ„å»º

```bash
npm install
npx prisma generate
npx prisma db push
npm run build
```

### 4.6 å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨ standalone æ¨¡å¼å¯åŠ¨
cd .next/standalone
pm2 start server.js --name lims-next -- -p 3001

# ä¿å­˜ PM2 é…ç½®
pm2 save
pm2 startup
```

---

## äº”ã€Claude Code è‡ªåŠ¨åŒ–éƒ¨ç½²å‘½ä»¤

### å¿«é€Ÿéƒ¨ç½²ï¼ˆä»£ç å·²æäº¤åˆ° GitHubï¼‰

```bash
# æœ¬åœ°æ„å»ºå¹¶éƒ¨ç½²
cd /Users/wangpeng/Downloads/limsnext && ./deploy-fast.sh
```

### å®Œæ•´éƒ¨ç½²ï¼ˆåŒ…å«ä»£ç æäº¤ï¼‰

```bash
# 1. æäº¤ä»£ç 
cd /Users/wangpeng/Downloads/limsnext
git add -A
git commit -m "feat: åŠŸèƒ½æè¿°"
git push origin master

# 2. éƒ¨ç½²
./deploy-fast.sh
```

### ä»…é‡å¯æœåŠ¡

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 restart lims-next"
```

### æŸ¥çœ‹æ—¥å¿—

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 logs lims-next --lines 50"
```

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 status"
```

---

## å…­ã€æ•°æ®åº“æ“ä½œ

### åŒæ­¥ Schemaï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "cd /root/lims-next && npx prisma db push"
```

### æ‰§è¡Œ Seedï¼ˆåˆå§‹åŒ–æ•°æ®ï¼‰

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "cd /root/lims-next && npm run db:seed"
```

---

## ä¸ƒã€å¸¸è§éƒ¨ç½²é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼ˆé‡è¦ï¼ï¼‰

### 7.1 Prisma è·¨å¹³å°é—®é¢˜

**é—®é¢˜**ï¼šæœ¬åœ° Mac æ„å»ºåéƒ¨ç½²åˆ° Linux æœåŠ¡å™¨ï¼ŒæŠ¥é”™ `Prisma Client could not locate the Query Engine for runtime "rhel-openssl-1.1.x"`

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ `prisma/schema.prisma` ä¸­æ·»åŠ  binaryTargetsï¼š

```prisma
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.1.x"]
}
```

### 7.2 NEXTAUTH_URL é…ç½®é”™è¯¯

**é—®é¢˜**ï¼šç™»å½•æŒ‰é’®ç‚¹å‡»æ— ååº”ï¼Œæ— ä»»ä½•æŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ `.env` ä¸­ `NEXTAUTH_URL` é…ç½®æ­£ç¡®ï¼š

```bash
NEXTAUTH_URL="http://8.130.182.148:3001"  # å¿…é¡»æ˜¯å®é™…è®¿é—®åœ°å€
```

### 7.3 Standalone æ¨¡å¼ç«¯å£é…ç½®

**é—®é¢˜**ï¼šstandalone æ¨¡å¼å¯åŠ¨åç«¯å£ä¸å¯¹ï¼ˆé»˜è®¤ 3000ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ PORT ç¯å¢ƒå˜é‡å¯åŠ¨ï¼š

```bash
# é”™è¯¯æ–¹å¼ï¼ˆå‚æ•°æ— æ•ˆï¼‰
pm2 start server.js --name lims-next -- -p 3001

# æ­£ç¡®æ–¹å¼
PORT=3001 pm2 start server.js --name lims-next
```

### 7.4 Static æ–‡ä»¶ 404

**é—®é¢˜**ï¼šé¡µé¢åŠ è½½æŠ¥é”™ `ChunkLoadError: Loading chunk xxx failed`ï¼Œé™æ€æ–‡ä»¶ 404

**åŸå› **ï¼šstandalone æ¨¡å¼éœ€è¦æ‰‹åŠ¨å¤åˆ¶ static æ–‡ä»¶å¤¹

**è§£å†³æ–¹æ¡ˆ**ï¼šéƒ¨ç½²åæ‰§è¡Œï¼š

```bash
cp -r .next/static .next/standalone/.next/
cp -r public .next/standalone/
cp .env .next/standalone/
```

**é‡è¦**ï¼šå¦‚æœä½¿ç”¨æœ¬åœ°æ„å»ºä¸Šä¼ æ¨¡å¼,éœ€è¦åœ¨æ‰“åŒ…æ—¶åŒ…å« `public` ç›®å½•ï¼š

```bash
# æ­£ç¡®çš„æ‰“åŒ…å‘½ä»¤
cd .next
tar -czf standalone.tar.gz standalone static
cd ..
tar -czf public.tar.gz public

# æˆ–è€…ä¸€æ¬¡æ€§æ‰“åŒ…
tar -czf deploy.tar.gz .next/standalone .next/static public
```

### 7.5 .env æ–‡ä»¶æœªå¤åˆ¶

**é—®é¢˜**ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥æˆ–è®¤è¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿ .env æ–‡ä»¶å¤åˆ¶åˆ° standalone ç›®å½•ï¼š

```bash
cp /root/lims-next/.env /root/lims-next/.next/standalone/.env
```

### 7.6 PM2 è¿›ç¨‹åƒµæ­» (PID æ˜¾ç¤º N/A)

**é—®é¢˜**ï¼š`pm2 status` æ˜¾ç¤ºè¿›ç¨‹ online ä½† PID ä¸º N/A,å†…å­˜ä¸º 0b,æœåŠ¡æ— æ³•è®¿é—®(502é”™è¯¯)

**åŸå› **ï¼šPM2 è¿›ç¨‹çŠ¶æ€å¼‚å¸¸,å®é™…è¿›ç¨‹å·²æ­»ä½† PM2 æœªæ£€æµ‹åˆ°

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# 1. åˆ é™¤åƒµæ­»è¿›ç¨‹
pm2 delete lims-next

# 2. æ¸…ç†å¯èƒ½çš„æ®‹ç•™è¿›ç¨‹
pkill -f 'node server.js'

# 3. é‡æ–°å¯åŠ¨
cd /root/lims-next
PORT=3001 pm2 start server.js --name lims-next --update-env

# 4. éªŒè¯å¯åŠ¨æˆåŠŸ
pm2 status lims-next
netstat -tulpn | grep 3001
```

### 7.7 ç«¯å£ç»‘å®šé”™è¯¯ (EADDRINUSE)

**é—®é¢˜**ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥,æ—¥å¿—æ˜¾ç¤º `Error: listen EADDRINUSE: address already in use 0.0.0.0:3000`

**åŸå› **ï¼š
1. Next.js standalone é»˜è®¤ä½¿ç”¨ 3000 ç«¯å£
2. PM2 å¯åŠ¨æ—¶æœªæ­£ç¡®ä¼ é€’ PORT ç¯å¢ƒå˜é‡

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# é”™è¯¯æ–¹å¼(ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ)
pm2 start server.js --name lims-next

# æ­£ç¡®æ–¹å¼(æ˜¾å¼æŒ‡å®š PORT)
PORT=3001 pm2 start server.js --name lims-next --update-env

# æˆ–è€…åœ¨å¯åŠ¨å‰è®¾ç½®ç¯å¢ƒå˜é‡
export PORT=3001
pm2 start server.js --name lims-next --update-env
```

### 7.8 ChunkLoadError: Loading chunk failed (404) âš ï¸ **æ¯æ¬¡éƒ¨ç½²åå¿…æ£€æŸ¥ï¼**

**é—®é¢˜ç°è±¡**ï¼š
- é¡µé¢æ˜¾ç¤º `Application error: a client-side exception has occurred`
- æµè§ˆå™¨æ§åˆ¶å°å¤§é‡ 404 é”™è¯¯ï¼š`GET /_next/static/chunks/6554-b4ff9...js 404 (Not Found)`
- é”™è¯¯ä¿¡æ¯ï¼š`ChunkLoadError: Loading chunk 6554 failed`

**æ ¹æœ¬åŸå› **ï¼šéƒ¨ç½²æ—¶**é—æ¼äº† `.next/static` ç›®å½•**

Next.js standalone æ¨¡å¼çš„ç›®å½•ç»“æ„ï¼š
- `.next/standalone/.next/` - åªåŒ…å«æœåŠ¡å™¨ç«¯ä»£ç ï¼ˆ**æ—  static æ–‡ä»¶ï¼**ï¼‰
- `.next/static/` - å®¢æˆ·ç«¯ JS/CSS chunk æ–‡ä»¶ï¼ˆ**éœ€è¦å•ç‹¬æ‰“åŒ…ä¸Šä¼ ï¼**ï¼‰
- `public/` - å…¬å…±é™æ€èµ„æº

**ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ¨ç½²éƒ½å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ**

å› ä¸º Next.js æ¯æ¬¡æ„å»ºéƒ½ä¼šï¼š
1. ç”Ÿæˆæ–°çš„ chunk æ–‡ä»¶ï¼ˆæ–‡ä»¶åå¸¦æ–°çš„ hashï¼‰
2. åˆ é™¤æ—§çš„ chunk æ–‡ä»¶
3. æµè§ˆå™¨ç¼“å­˜äº†æ—§ HTMLï¼Œå°è¯•åŠ è½½å·²è¢«åˆ é™¤çš„æ—§ chunk â†’ 404 é”™è¯¯

**å®Œæ•´è§£å†³æ–¹æ¡ˆï¼ˆ3æ­¥ä¿®å¤ï¼‰**ï¼š

```bash
# === æ­¥éª¤1ï¼šä»æœ¬åœ°é‡æ–°ä¸Šä¼  static ç›®å½• ===

# 1.1 æœ¬åœ°æ‰“åŒ… static ç›®å½•
cd /Users/wangpeng/Downloads/limsnext/.next
tar -czf static.tar.gz static

# 1.2 ä¸Šä¼ åˆ°æœåŠ¡å™¨
sshpass -p 'xx198910170014Z' scp static.tar.gz root@8.130.182.148:/root/lims-next/

# 1.3 æœåŠ¡å™¨ç«¯è§£å‹åˆ°æ­£ç¡®ä½ç½®
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "cd /root/lims-next && tar -xzf static.tar.gz && pm2 restart lims-next"

# === æ­¥éª¤2ï¼šéªŒè¯ä¿®å¤æˆåŠŸ ===

# 2.1 æ£€æŸ¥ static ç›®å½•å­˜åœ¨
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "ls -la /root/lims-next/.next/static/chunks/ | head -10"
# åº”è¯¥çœ‹åˆ°å¤§é‡ .js æ–‡ä»¶

# 2.2 æµ‹è¯•é™æ€æ–‡ä»¶å¯è®¿é—®ï¼ˆä»æµè§ˆå™¨é”™è¯¯ä¸­å¤åˆ¶ä»»æ„ä¸€ä¸ª chunk æ–‡ä»¶åï¼‰
curl -I http://8.130.182.148:3001/_next/static/chunks/6554-b4ff9...js
# åº”è¯¥è¿”å› 200 OK

# === æ­¥éª¤3ï¼šæµè§ˆå™¨å¼ºåˆ¶åˆ·æ–° ===

# ç”¨æˆ·ç«¯æ“ä½œï¼šæŒ‰ Ctrl+Shift+R (Windows) æˆ– Cmd+Shift+R (Mac) å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨
```

**é¢„é˜²æªæ–½ï¼ˆä¿®æ”¹ deploy-fast.shï¼‰**ï¼š

åœ¨ `deploy-fast.sh` è„šæœ¬ä¸­**å¿…é¡»åŒ…å«ä»¥ä¸‹3ä¸ªæ‰“åŒ…æ­¥éª¤**ï¼š

```bash
# âœ… æ­£ç¡®çš„æ‰“åŒ…æ­¥éª¤ï¼ˆ3ä¸ªæ–‡ä»¶éƒ½è¦æ‰“åŒ…ï¼ï¼‰
cd .next && tar -czf standalone.tar.gz standalone && cd ..
tar -czf static.tar.gz .next/static  # âš ï¸ å…³é”®ï¼ä¸èƒ½é—æ¼ï¼
tar -czf public.tar.gz public

# âœ… ä¸Šä¼ æ­¥éª¤ï¼ˆ3ä¸ªæ–‡ä»¶éƒ½è¦ä¸Šä¼ ï¼ï¼‰
sshpass -p "$SERVER_PASS" scp .next/standalone.tar.gz "$SERVER:$REMOTE_DIR/"
sshpass -p "$SERVER_PASS" scp static.tar.gz "$SERVER:$REMOTE_DIR/"  # âš ï¸ å…³é”®ï¼
sshpass -p "$SERVER_PASS" scp public.tar.gz "$SERVER:$REMOTE_DIR/"

# âœ… è§£å‹æ­¥éª¤ï¼ˆ3ä¸ªæ–‡ä»¶éƒ½è¦è§£å‹ï¼ï¼‰
sshpass -p "$SERVER_PASS" ssh "$SERVER" "cd $REMOTE_DIR && \
  tar -xzf standalone.tar.gz && \
  tar -xzf static.tar.gz && \
  tar -xzf public.tar.gz && \
  rm -rf .next && \
  mv standalone/.next . && \
  pm2 restart lims-next"
```

**éƒ¨ç½²åéªŒè¯æ¸…å•ï¼ˆæ¯æ¬¡éƒ¨ç½²å¿…æŸ¥ï¼‰**ï¼š

- [ ] `.next/static/chunks/` ç›®å½•å­˜åœ¨ï¼š`ls .next/static/chunks/`
- [ ] chunk æ–‡ä»¶æ•°é‡ > 100ï¼š`find .next/static -name "*.js" | wc -l`
- [ ] æµè§ˆå™¨è®¿é—®ä»»æ„ chunk æ–‡ä»¶è¿”å› 200
- [ ] é¡µé¢å¼ºåˆ¶åˆ·æ–°åæ—  ChunkLoadError
- [ ] æ§åˆ¶å°æ—  404 é”™è¯¯

**å¿«é€Ÿæ£€æŸ¥å‘½ä»¤**ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œæ£€æŸ¥ static æ˜¯å¦å®Œæ•´
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "
  echo '=== æ£€æŸ¥ static ç›®å½• ==='
  ls -lh /root/lims-next/.next/static/ 2>/dev/null || echo 'âŒ static ç›®å½•ä¸å­˜åœ¨ï¼'
  echo ''
  echo '=== chunk æ–‡ä»¶æ•°é‡ ==='
  find /root/lims-next/.next/static -name '*.js' 2>/dev/null | wc -l
"
```

### 7.9 ç”Ÿäº§ç¯å¢ƒç¼ºå¤± .next ç›®å½•

**é—®é¢˜**ï¼šPM2 æ—¥å¿—æ˜¾ç¤º `Error: Could not find a production build in the './.next' directory`

**åŸå› **ï¼šéƒ¨ç½²æ—¶ `cp standalone/*` å‘½ä»¤è·³è¿‡äº†éšè—çš„ `.next` ç›®å½•

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
cd /root/lims-next

# 1. ä» standalone å¤åˆ¶ .next ç›®å½•
cp -r standalone/.next .

# 2. å¤åˆ¶ static æ–‡ä»¶
cp -r static/* .next/static/

# 3. é‡å¯æœåŠ¡
pm2 restart lims-next
```

### 7.10 ç¼ºå¤± public ç›®å½•å¯¼è‡´æ‰€æœ‰é™æ€æ–‡ä»¶ 404

**é—®é¢˜**ï¼šé¡µé¢åŠ è½½åæ‰€æœ‰ chunk æ–‡ä»¶ 404,æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºå¤§é‡ `GET /_next/static/chunks/xxx.js 404 (Not Found)` é”™è¯¯

**åŸå› **ï¼šNext.js standalone æ¨¡å¼**ä¸ä¼šè‡ªåŠ¨æ‰“åŒ… `public` ç›®å½•**,éœ€è¦æ‰‹åŠ¨å¤åˆ¶

**å®Œæ•´è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ–¹æ³•1: ä»æœ¬åœ°ä¸Šä¼  public ç›®å½•
cd /path/to/local/project
tar -czf public.tar.gz public
scp public.tar.gz root@8.130.182.148:/root/lims-next/
ssh root@8.130.182.148 "cd /root/lims-next && tar -xzf public.tar.gz && rm public.tar.gz"

# æ–¹æ³•2: åœ¨æœåŠ¡å™¨ä¸Šä»æºç å¤åˆ¶
ssh root@8.130.182.148
cd /root/lims-next
git pull  # ç¡®ä¿æœ‰æœ€æ–°çš„ public ç›®å½•
# public ç›®å½•å·²å­˜åœ¨äº git ä»“åº“ä¸­

# é‡å¯æœåŠ¡
pm2 restart lims-next
```

**éªŒè¯ä¿®å¤**ï¼š

```bash
# æ£€æŸ¥ public ç›®å½•æ˜¯å¦å­˜åœ¨
ls -la /root/lims-next/public/

# æµ‹è¯•é™æ€æ–‡ä»¶è®¿é—®
curl -I http://8.130.182.148:3001/_next/static/chunks/framework-xxx.js
# åº”è¯¥è¿”å› 200 OK
```

**é¢„é˜²æªæ–½**ï¼šæ›´æ–° `deploy-fast.sh` è„šæœ¬,ç¡®ä¿åŒ…å« public ç›®å½•ï¼š

```bash
# åœ¨æ‰“åŒ…æ­¥éª¤æ·»åŠ  public
tar -czf standalone.tar.gz .next/standalone .next/static public
```

### 7.11 BUILD_ID ä¸åŒ¹é…å¯¼è‡´ ChunkLoadError

**é—®é¢˜**ï¼šéƒ¨ç½²åé¡µé¢åŠ è½½æŠ¥é”™ `ChunkLoadError`,æµè§ˆå™¨è¯·æ±‚çš„chunkæ–‡ä»¶åä¸æœåŠ¡å™¨ä¸Šçš„ä¸ä¸€è‡´

**åŸå› **ï¼šéƒ¨ç½²è„šæœ¬é”™è¯¯åœ°è¦†ç›–äº† `.next` ç›®å½•,å¯¼è‡´ BUILD_ID ä¸åŒ¹é…

**é”™è¯¯çš„éƒ¨ç½²é€»è¾‘**ï¼š

```bash
# âŒ é”™è¯¯:ä¼šè¦†ç›–.nextç›®å½•
tar -xzf standalone.tar.gz -C .next
cp -r .next/standalone/* .  # è¿™ä¼šè¦†ç›–.nextç›®å½•!
```

**æ­£ç¡®çš„éƒ¨ç½²é€»è¾‘**ï¼š

```bash
# âœ… æ­£ç¡®:ç›´æ¥ç§»åŠ¨.nextç›®å½•
tar -xzf standalone.tar.gz
rm -rf .next
mv standalone/.next .  # ç›´æ¥ç§»åŠ¨,ä¿æŒBUILD_IDä¸€è‡´
cp -r static/* .next/static/
cp standalone/server.js .
```

**å®Œæ•´ä¿®å¤æ–¹æ¡ˆ**ï¼š

```bash
cd /root/lims-next

# 1. é‡æ–°éƒ¨ç½²(ä½¿ç”¨ä¿®å¤åçš„deploy-fast.sh)
# æˆ–æ‰‹åŠ¨ä¿®å¤:

# 2. æ¸…ç†æ—§æ–‡ä»¶
rm -rf .next standalone

# 3. é‡æ–°è§£å‹
tar -xzf standalone.tar.gz

# 4. æ­£ç¡®ç§»åŠ¨æ–‡ä»¶
rm -rf .next
mv standalone/.next .
cp -r static/* .next/static/
cp standalone/server.js .
cp standalone/package.json .

# 5. æ¸…ç†
rm -rf standalone

# 6. é‡å¯æœåŠ¡
pm2 restart lims-next
```

**éªŒè¯ä¿®å¤**ï¼š

```bash
# æ£€æŸ¥BUILD_IDæ˜¯å¦ä¸€è‡´
cat .next/BUILD_ID
ls .next/static/chunks/app/(dashboard)/system/user/

# æµ‹è¯•é¡µé¢è®¿é—®
curl -I http://8.130.182.148:3001/system/user
# åº”è¯¥è¿”å› 200 OK æˆ– 307 (é‡å®šå‘)
```

> âš ï¸ **é‡è¦**: åœ¨å¤åˆ¶staticæ–‡ä»¶å‰,å¿…é¡»å…ˆæ‰§è¡Œ `mkdir -p .next/static`,å› ä¸ºä»standaloneç§»åŠ¨è¿‡æ¥çš„`.next`ç›®å½•ä¸åŒ…å«`static`å­ç›®å½•ã€‚






---

## å…«ã€æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs lims-next --err --lines 100

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 3001

# é‡æ–°å¯åŠ¨
pm2 delete lims-next
cd /root/lims-next/.next/standalone
pm2 start server.js --name lims-next -- -p 3001
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat /root/lims-next/.env

# æµ‹è¯•æ•°æ®åº“è¿æ¥
cd /root/lims-next && npx prisma db pull
```

### æ„å»ºå¤±è´¥

```bash
# æ¸…ç†ç¼“å­˜é‡æ–°æ„å»º
rm -rf .next node_modules
npm install
npm run build
```

---

## å…«ã€é˜²ç«å¢™é…ç½®

```bash
# å¼€æ”¾ 3001 ç«¯å£
firewall-cmd --permanent --add-port=3001/tcp
firewall-cmd --reload

# æˆ–ä½¿ç”¨ iptables
iptables -A INPUT -p tcp --dport 3001 -j ACCEPT
```

---

## ä¹ã€Nginx åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## åã€è®¿é—®åœ°å€

- **HTTP**: http://8.130.182.148:3001
- **é»˜è®¤è´¦å·**: admin
- **é»˜è®¤å¯†ç **: admin123
