# LIMS-Next 部署文档 - 阿里云

> 最后更新: 2026-01-09 | 适用于 Claude Code 自动化部署

---

## 一、服务器信息

| 项目 | 值 |
|------|-----|
| 服务器IP | 8.130.182.148 |
| 操作系统 | CentOS / AlmaLinux |
| 用户名 | root |
| 密码 | xx198910170014Z |
| 项目路径 | /root/lims-next |
| 服务端口 | 3001 |
| PM2进程名 | lims-next |

---

## 二、环境要求

| 软件 | 版本要求 | 检查命令 |
|------|----------|----------|
| Node.js | >= 18.x | `node -v` |
| npm | >= 9.x | `npm -v` |
| PM2 | >= 5.x | `pm2 -v` |
| Git | >= 2.x | `git --version` |

---

## 三、快速部署（推荐）

### 方式一：本地构建 + 上传（最快）

在本地机器执行，利用本地 CPU 构建，只上传 18MB 压缩包：

```bash
# 1. 进入项目目录
cd /Users/wangpeng/Downloads/limsnext

# 2. 执行快速部署脚本
./deploy-fast.sh
```

**脚本执行流程**：
1. 本地执行 `npm run build`（生成 standalone）
2. 打包 `.next/standalone` + `.next/static` + `public`（约 18MB）
3. 上传到服务器
4. 服务器解压并重启 PM2

> ⚠️ **重要**：确保打包时包含 `public` 目录,否则会导致所有静态文件 404

**预计耗时**：1-2 分钟

---

### 方式二：服务器直接部署

SSH 到服务器执行（适用于服务器 CPU 较强或无法本地构建时）：

```bash
# 1. SSH 连接服务器
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148

# 2. 进入项目目录
cd /root/lims-next

# 3. 拉取最新代码
git pull

# 4. 安装依赖（仅 package.json 变更时需要）
npm install

# 5. 同步数据库
npx prisma db push

# 6. 构建项目
npm run build

# 7. 重启服务
pm2 restart lims-next
```

**预计耗时**：5-10 分钟

---

## 四、首次部署（全新服务器）

### 4.1 安装 Node.js

```bash
# 使用 nvm 安装
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

### 4.2 安装 PM2

```bash
npm install -g pm2
```

### 4.3 克隆项目

```bash
cd /root
git clone https://github.com/wangpeng1017/0105LIMENEXT.git lims-next
cd lims-next
```

### 4.4 配置环境变量

```bash
cat > .env << 'EOF'
DATABASE_URL="postgresql://用户名:密码@数据库地址:5432/数据库名"
NEXTAUTH_SECRET="your-secret-key-here"
NEXTAUTH_URL="http://8.130.182.148:3001"
EOF
```

### 4.5 安装依赖并构建

```bash
npm install
npx prisma generate
npx prisma db push
npm run build
```

### 4.6 启动服务

```bash
# 使用 standalone 模式启动
cd .next/standalone
pm2 start server.js --name lims-next -- -p 3001

# 保存 PM2 配置
pm2 save
pm2 startup
```

---

## 五、Claude Code 自动化部署命令

### 快速部署（代码已提交到 GitHub）

```bash
# 本地构建并部署
cd /Users/wangpeng/Downloads/limsnext && ./deploy-fast.sh
```

### 完整部署（包含代码提交）

```bash
# 1. 提交代码
cd /Users/wangpeng/Downloads/limsnext
git add -A
git commit -m "feat: 功能描述"
git push origin master

# 2. 部署
./deploy-fast.sh
```

### 仅重启服务

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 restart lims-next"
```

### 查看日志

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 logs lims-next --lines 50"
```

### 查看服务状态

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "pm2 status"
```

---

## 六、数据库操作

### 同步 Schema（开发环境）

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "cd /root/lims-next && npx prisma db push"
```

### 执行 Seed（初始化数据）

```bash
sshpass -p 'xx198910170014Z' ssh root@8.130.182.148 "cd /root/lims-next && npm run db:seed"
```

---

## 七、常见部署问题及解决方案（重要！）

### 7.1 Prisma 跨平台问题

**问题**：本地 Mac 构建后部署到 Linux 服务器，报错 `Prisma Client could not locate the Query Engine for runtime "rhel-openssl-1.1.x"`

**解决方案**：在 `prisma/schema.prisma` 中添加 binaryTargets：

```prisma
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.1.x"]
}
```

### 7.2 NEXTAUTH_URL 配置错误

**问题**：登录按钮点击无反应，无任何报错

**解决方案**：确保 `.env` 中 `NEXTAUTH_URL` 配置正确：

```bash
NEXTAUTH_URL="http://8.130.182.148:3001"  # 必须是实际访问地址
```

### 7.3 Standalone 模式端口配置

**问题**：standalone 模式启动后端口不对（默认 3000）

**解决方案**：使用 PORT 环境变量启动：

```bash
# 错误方式（参数无效）
pm2 start server.js --name lims-next -- -p 3001

# 正确方式
PORT=3001 pm2 start server.js --name lims-next
```

### 7.4 Static 文件 404

**问题**：页面加载报错 `ChunkLoadError: Loading chunk xxx failed`，静态文件 404

**原因**：standalone 模式需要手动复制 static 文件夹

**解决方案**：部署后执行：

```bash
cp -r .next/static .next/standalone/.next/
cp -r public .next/standalone/
cp .env .next/standalone/
```

**重要**：如果使用本地构建上传模式,需要在打包时包含 `public` 目录：

```bash
# 正确的打包命令
cd .next
tar -czf standalone.tar.gz standalone static
cd ..
tar -czf public.tar.gz public

# 或者一次性打包
tar -czf deploy.tar.gz .next/standalone .next/static public
```

### 7.5 .env 文件未复制

**问题**：数据库连接失败或认证失败

**解决方案**：确保 .env 文件复制到 standalone 目录：

```bash
cp /root/lims-next/.env /root/lims-next/.next/standalone/.env
```

### 7.6 PM2 进程僵死 (PID 显示 N/A)

**问题**：`pm2 status` 显示进程 online 但 PID 为 N/A,内存为 0b,服务无法访问(502错误)

**原因**：PM2 进程状态异常,实际进程已死但 PM2 未检测到

**解决方案**：

```bash
# 1. 删除僵死进程
pm2 delete lims-next

# 2. 清理可能的残留进程
pkill -f 'node server.js'

# 3. 重新启动
cd /root/lims-next
PORT=3001 pm2 start server.js --name lims-next --update-env

# 4. 验证启动成功
pm2 status lims-next
netstat -tulpn | grep 3001
```

### 7.7 端口绑定错误 (EADDRINUSE)

**问题**：服务启动失败,日志显示 `Error: listen EADDRINUSE: address already in use 0.0.0.0:3000`

**原因**：
1. Next.js standalone 默认使用 3000 端口
2. PM2 启动时未正确传递 PORT 环境变量

**解决方案**：

```bash
# 错误方式(环境变量未生效)
pm2 start server.js --name lims-next

# 正确方式(显式指定 PORT)
PORT=3001 pm2 start server.js --name lims-next --update-env

# 或者在启动前设置环境变量
export PORT=3001
pm2 start server.js --name lims-next --update-env
```

### 7.8 ChunkLoadError: Loading chunk failed (404)

**问题**：页面加载报错 `ChunkLoadError: Loading chunk xxx failed`,浏览器控制台显示 `/_next/static/chunks/app/(dashboard)/xxx/page-xxx.js` 404

**原因**：`.next/static` 目录结构不正确或文件未正确复制

**完整解决方案**：

```bash
cd /root/lims-next

# 1. 清理旧的 static 目录
rm -rf .next/static

# 2. 重新复制(确保包含所有子目录)
mkdir -p .next/static
cp -r static/* .next/static/

# 3. 验证文件存在
ls -la .next/static/chunks/app/

# 4. 无需重启 PM2,刷新浏览器即可
```

**注意**：
- `static` 目录包含所有构建生成的 chunk 文件
- 必须使用 `cp -r static/*` 而不是 `cp -r static`,否则会多一层目录
- 如果问题依然存在,检查 `.next/BUILD_ID` 是否正确

### 7.9 生产环境缺失 .next 目录

**问题**：PM2 日志显示 `Error: Could not find a production build in the './.next' directory`

**原因**：部署时 `cp standalone/*` 命令跳过了隐藏的 `.next` 目录

**解决方案**：

```bash
cd /root/lims-next

# 1. 从 standalone 复制 .next 目录
cp -r standalone/.next .

# 2. 复制 static 文件
cp -r static/* .next/static/

# 3. 重启服务
pm2 restart lims-next
```

### 7.10 缺失 public 目录导致所有静态文件 404

**问题**：页面加载后所有 chunk 文件 404,浏览器控制台显示大量 `GET /_next/static/chunks/xxx.js 404 (Not Found)` 错误

**原因**：Next.js standalone 模式**不会自动打包 `public` 目录**,需要手动复制

**完整解决方案**：

```bash
# 方法1: 从本地上传 public 目录
cd /path/to/local/project
tar -czf public.tar.gz public
scp public.tar.gz root@8.130.182.148:/root/lims-next/
ssh root@8.130.182.148 "cd /root/lims-next && tar -xzf public.tar.gz && rm public.tar.gz"

# 方法2: 在服务器上从源码复制
ssh root@8.130.182.148
cd /root/lims-next
git pull  # 确保有最新的 public 目录
# public 目录已存在于 git 仓库中

# 重启服务
pm2 restart lims-next
```

**验证修复**：

```bash
# 检查 public 目录是否存在
ls -la /root/lims-next/public/

# 测试静态文件访问
curl -I http://8.130.182.148:3001/_next/static/chunks/framework-xxx.js
# 应该返回 200 OK
```

**预防措施**：更新 `deploy-fast.sh` 脚本,确保包含 public 目录：

```bash
# 在打包步骤添加 public
tar -czf standalone.tar.gz .next/standalone .next/static public
```

### 7.11 BUILD_ID 不匹配导致 ChunkLoadError

**问题**：部署后页面加载报错 `ChunkLoadError`,浏览器请求的chunk文件名与服务器上的不一致

**原因**：部署脚本错误地覆盖了 `.next` 目录,导致 BUILD_ID 不匹配

**错误的部署逻辑**：

```bash
# ❌ 错误:会覆盖.next目录
tar -xzf standalone.tar.gz -C .next
cp -r .next/standalone/* .  # 这会覆盖.next目录!
```

**正确的部署逻辑**：

```bash
# ✅ 正确:直接移动.next目录
tar -xzf standalone.tar.gz
rm -rf .next
mv standalone/.next .  # 直接移动,保持BUILD_ID一致
cp -r static/* .next/static/
cp standalone/server.js .
```

**完整修复方案**：

```bash
cd /root/lims-next

# 1. 重新部署(使用修复后的deploy-fast.sh)
# 或手动修复:

# 2. 清理旧文件
rm -rf .next standalone

# 3. 重新解压
tar -xzf standalone.tar.gz

# 4. 正确移动文件
rm -rf .next
mv standalone/.next .
cp -r static/* .next/static/
cp standalone/server.js .
cp standalone/package.json .

# 5. 清理
rm -rf standalone

# 6. 重启服务
pm2 restart lims-next
```

**验证修复**：

```bash
# 检查BUILD_ID是否一致
cat .next/BUILD_ID
ls .next/static/chunks/app/(dashboard)/system/user/

# 测试页面访问
curl -I http://8.130.182.148:3001/system/user
# 应该返回 200 OK 或 307 (重定向)
```




---

## 八、故障排查

### 服务无法启动

```bash
# 查看错误日志
pm2 logs lims-next --err --lines 100

# 检查端口占用
netstat -tlnp | grep 3001

# 重新启动
pm2 delete lims-next
cd /root/lims-next/.next/standalone
pm2 start server.js --name lims-next -- -p 3001
```

### 数据库连接失败

```bash
# 检查环境变量
cat /root/lims-next/.env

# 测试数据库连接
cd /root/lims-next && npx prisma db pull
```

### 构建失败

```bash
# 清理缓存重新构建
rm -rf .next node_modules
npm install
npm run build
```

---

## 八、防火墙配置

```bash
# 开放 3001 端口
firewall-cmd --permanent --add-port=3001/tcp
firewall-cmd --reload

# 或使用 iptables
iptables -A INPUT -p tcp --dport 3001 -j ACCEPT
```

---

## 九、Nginx 反向代理（可选）

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## 十、访问地址

- **HTTP**: http://8.130.182.148:3001
- **默认账号**: admin
- **默认密码**: admin123
