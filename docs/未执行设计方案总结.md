# 未执行设计方案总结

> 生成时间: 2026-02-02
> 说明: 本文档汇总所有agent已设计但未实施的方案

---

## 一、报价单生成改进方案

**文档**: `docs/QUOTATION_GENERATION_IMPROVEMENT.md`
**设计时间**: 2026-02-02
**状态**: 待实施

### 问题描述

点击"生成报价单"按钮后，只在控制台提示警告，用户不知道具体哪些样品检测项未完成评估。

### 推荐方案：Modal详情展示（方案一）

**UI设计**:
- Modal宽度: 700px
- 表格列: 样品名称、检测项目、检测标准、评估状态、评估人
- 表格支持滚动(scroll.y: 300)
- 底部提示信息

**核心实现**:

```typescript
// 1. 定义状态类型
interface UnfinishedItem {
  id: string
  sampleName: string
  testItemName: string
  testStandard?: string
  assessmentStatus: 'pending' | 'assessing' | 'rejected'
  assessorName?: string
}

// 2. Modal组件
function showAssessmentWarningModal(items: UnfinishedItem[]) {
  Modal.warning({
    title: '评估未完成',
    width: 700,
    centered: true,
    content: (
      <div>
        <p>以下 <strong>{items.length}</strong> 个样品检测项尚未完成评估：</p>
        <Table
          dataSource={items}
          rowKey="id"
          pagination={false}
          size="small"
          bordered
          columns={[...]} // 样品名称、检测项目、检测标准、评估状态、评估人
          scroll={{ y: 300 }}
        />
        <Alert message="💡 提示" description="请先完成以上项目的评估后再生成报价单" type="info" showIcon />
      </div>
    ),
    okText: '我知道了'
  })
}
```

**代码位置**: `src/app/(dashboard)/entrustment/consultation/page.tsx:566-642`

---

## 二、业务流程优化设计

**文档**: `docs/plans/2026-01-28-business-workflow-enhancement-design.md`
**设计时间**: 2026-01-28
**状态**: 待实施

### 模块1: 报价/合同/委托单关系优化

**需求**: 支持报价单直接生成委托单，跳过合同环节

**数据库变更**:
```prisma
model Entrustment {
  // 新增：来源追踪
  sourceType      String?  @db.VarChar(20)  // contract/quotation/direct
  sourceId        String?  @db.VarChar(50)  // 来源单据ID
  sourceNo        String?  @db.VarChar(50)  // 来源单据号（冗余）

  // 新增：报价单关联
  quotationNo     String?  @db.VarChar(50)  // 报价单号
  quotationId     String?  @db.VarChar(50)  // 报价单ID
  quotation       Quotation? @relation(fields: [quotationId], references: [id])

  @@index([quotationId])
  @@index([sourceType])
}
```

**新增API**: `POST /api/quotation/[id]/create-entrustment`

**UI变更**: 报价单列表添加"生成委托单"按钮

---

### 模块2: 审批流驳回功能

**需求**: 完善驳回流程，包括驳回原因、修改指引、驳回历史

**数据库变更**:
```prisma
model Quotation {  // Contract, Entrustment, Client 等类似
  // 新增：驳回记录
  rejectedCount    Int      @default(0)
  lastRejectReason String?  @db.Text
  lastRejectBy     String?  @db.VarChar(50)
  lastRejectAt     DateTime?
}
```

**新增API**:
- `POST /api/quotation/[id]/reject` - 驳回单据
- `POST /api/quotation/[id]/resubmit` - 重新提交

**UI设计**:
- 驳回确认弹窗（必填驳回原因）
- 列表页显示驳回状态和原因
- 编辑弹窗显示红色警告条

---

### 模块3: 报价单PDF生成审批控制

**需求**: 只有审批通过后才能生成PDF

**状态控制**:
```typescript
type QuotationStatus =
  | 'draft'      // 草稿
  | 'pending'    // 审批中
  | 'approved'   // 审批通过 ✅ 可生成PDF
  | 'rejected'   // 已驳回
  | 'archived'   // 已归档
```

**API层验证**:
```typescript
// POST /api/quotation/[id]/generate-pdf
if (quotation.status !== 'approved') {
  return NextResponse.json({
    success: false,
    error: `报价单尚未审批通过，当前状态：${quotation.status}`
  }, { status: 403 })
}
```

**UI层控制**: 按钮disabled + Tooltip提示

---

### 模块4: 业务单位审批流

**需求**: 实现简单的管理员审批流程

**状态定义**:
```typescript
type ClientStatus =
  | 'draft'      // 草稿
  | 'pending'    // 审批中
  | 'approved'   // 已通过
  | 'rejected'   // 已驳回
```

**权限控制**: 审批人配置 `['admin', 'manager']`

**新增API**:
- `POST /api/client/[id]/submit` - 提交审批
- `POST /api/client/[id]/approve` - 审批

---

## 三、三个功能实现设计

**文档**: `docs/plans/2026-01-29-three-features-design.md`
**设计时间**: 2026-01-29
**状态**: 待实施

### 功能1: 报价单列表增加"报告时间"列

**需求**: 客户报告截止日期需要在整个业务流程中显示

**数据库变更**:
- `biz_consultation` 添加 `clientReportDeadline: DateTime?`
- `biz_quotation` 添加 `clientReportDeadline: DateTime?`
- `biz_contract` 添加 `clientReportDeadline: DateTime?`
- `biz_entrustment` 添加 `clientReportDeadline: DateTime?`
- `biz_test_task` 添加 `clientReportDeadline: DateTime?`

**数据继承逻辑**:
```
咨询（手动输入）→ 报价单（继承，可编辑）→ 委托单（继承，可编辑）→ 任务（继承，可编辑）
```

**前端修改**:
- 业务咨询页面：新增"报告时间"列 + 日期选择器
- 报价单页面：新增"报告时间"列 + 日期选择器
- 委托单页面：新增"报告时间"列 + 日期选择器
- 检测任务页面：新增"报告时间"列

**样式规范**:
- 红色：过期时间
- 橙色：7天内到期
- 绿色：正常时间

---

### 功能2: 外包管理菜单优化

**需求**:
- 委外订单：显示所有订单
- 我的委外：只显示当前用户作为"内部负责人"的订单

**查询逻辑**:
```sql
-- 委外订单：无过滤
SELECT * FROM biz_outsource_order ORDER BY createdAt DESC

-- 我的委外：过滤subcontractAssignee
SELECT DISTINCT oo.*
FROM biz_outsource_order oo
INNER JOIN biz_test_task tt ON tt.id = oo.taskId
INNER JOIN biz_entrustment_project ep ON ep.id = tt.projectId
WHERE ep.subcontractAssignee = {当前用户ID}
ORDER BY oo.createdAt DESC
```

**API修改**: `GET /api/outsource-order?filter=my`

**前端修改**:
- 委外订单页面：新增"内部负责人"列
- 我的委外页面：使用filter=my参数

---

### 功能3: 样品标签生成增强

**需求**: 在一维码下面增加"检测项目"字段显示，多行显示

**组件修改**: `src/app/(dashboard)/sample/receipt/page.tsx`

**实现逻辑**:
```tsx
// 1. 打开标签时查询检测项
const handleShowLabel = async (record: Sample) => {
  const res = await fetch(`/api/sample-test-item?bizType=sample_receipt&bizId=${record.id}`)
  const testItems = json.data.map((item: any) => item.testItemName)
  setLabelTestItems(testItems)
}

// 2. 标签渲染（一维码下方显示检测项）
{labelTestItems.length > 0 && (
  <>
    <div style={{ fontWeight: 'bold' }}>检测项目:</div>
    {labelTestItems.map((item, index) => (
      <div key={index}>{index + 1}. {item}</div>
    ))}
  </>
)}
```

---

## 四、委托合同和委托单增强

**文档**: `docs/FEATURE_PLAN_委托合同和委托单增强.md`
**设计时间**: 2026-01-08
**状态**: 待实施

### 功能1: 委托合同页面增强

**需求**:
- 右上角增加"下载PDF"按钮（导出完整合同信息）
- 增加"生成委托单"按钮（把合同信息带入委托单页面）

**实现方案**:
1. 创建 `src/lib/exportContractPDF.ts` - 合同PDF导出工具
2. 修改 `src/app/(dashboard)/entrustment/contract/page.tsx` - 添加按钮和处理逻辑
3. 修改 `src/app/(dashboard)/entrustment/list/page.tsx` - 支持URL参数自动填充

**按钮布局**:
```tsx
<Space>
  <Button icon={<DownloadOutlined />}>下载PDF</Button>
  <Button icon={<FileAddOutlined />}>生成委托单</Button>
  <Button type="primary">新增合同</Button>
</Space>
```

---

### 功能2: 委托单外部链接

**需求**: 客户通过外部链接填写/补充样品信息、检测项目等

**数据存储**: 使用现有remark字段存储token信息
```json
{
  "externalLink": {
    "token": "abc123...",
    "expiresAt": "2026-01-15T00:00:00.000Z"
  }
}
```

**需要创建的文件**:
- `src/app/api/entrustment/external-link/route.ts` - 生成外部链接API
- `src/app/external/entrustment/[token]/page.tsx` - 外部链接页面
- `src/app/api/external/entrustment/validate/route.ts` - 验证token
- `src/app/api/external/entrustment/submit/route.ts` - 提交数据

**安全性**:
- Token: 32字节随机字符串（64位十六进制）
- 过期时间: 7天
- 验证码: 4位前端生成验证码

---

## 五、实施优先级建议

### 优先级排序

| 优先级 | 方案 | 预计工时 | 理由 |
|--------|------|----------|------|
| **P0** | 报价单生成改进 | 1小时 | 立即提升用户体验 |
| **P0** | 报价单PDF控制 | 2小时 | 最简单，立即可用 |
| **P1** | 样品标签增强 | 2小时 | 独立性强，快速实现 |
| **P1** | 外包管理优化 | 5小时 | 中等难度 |
| **P1** | 外部链接功能 | 3小时 | 客户需求 |
| **P2** | 审批流驳回 | 4小时 | 核心功能 |
| **P2** | 业务单位审批 | 3小时 | 完善审批流程 |
| **P2** | 报价/合同/委托关系 | 6小时 | 业务流程调整 |
| **P3** | 报告时间列 | 11小时 | 最复杂，涉及多表 |

**总计**: 约37小时

---

## 六、快速实施路线图

### 第一周（快速见效）

1. **报价单生成改进**（1小时）
   - 修改 `consultation/page.tsx`
   - 实现Modal表格显示
   - 测试验收

2. **报价单PDF控制**（2小时）
   - API层验证
   - UI层disabled控制
   - 测试验收

3. **样品标签增强**（2小时）
   - 修改 `receipt/page.tsx`
   - 添加检测项查询和渲染
   - 测试验收

### 第二周（功能完善）

4. **外部链接功能**（3小时）
5. **外包管理优化**（5小时）
6. **审批流驳回**（4小时）

### 第三周（业务优化）

7. **业务单位审批**（3小时）
8. **报价/合同/委托关系**（6小时）

### 第四周（复杂功能）

9. **报告时间列**（11小时）

---

## 七、技术要点总结

### 数据库变更原则

1. **优先使用现有字段** - 如外部链接使用remark存储token
2. **冗余存储关键信息** - 如sourceNo防止源单据删除
3. **添加索引提升查询** - 如quotationId、sourceType

### API设计规范

1. **统一返回格式** - `{ success: boolean, data?: T, error?: string }`
2. **API层验证** - 状态检查、权限验证
3. **错误友好提示** - 明确告知用户下一步操作

### UI交互规范

1. **Modal宽度** - 表格用700px，简单提示用500px
2. **表格配置** - bordered、size="small"、scroll.y支持
3. **状态颜色** - 成功(绿)、处理中(蓝)、警告(橙)、错误(红)
4. **按钮disabled** - 配合Tooltip说明原因

---

## 八、验收标准总览

### 报价单生成改进
- [ ] Modal显示未完成评估项表格
- [ ] 表格包含样品名称、检测项目、评估状态、评估人
- [ ] 底部显示提示信息

### 报价单PDF控制
- [ ] draft状态无法生成PDF
- [ ] pending状态无法生成PDF
- [ ] 只有approved状态可生成PDF
- [ ] API层也验证状态

### 样品标签增强
- [ ] 一维码下方显示检测项目
- [ ] 多行显示，每个项目一行
- [ ] 无检测项时不显示该区域

### 外部链接功能
- [ ] 生成32字节随机token
- [ ] 外部页面验证token有效性
- [ ] 客户提交直接保存到委托单
- [ ] 7天后自动过期

### 外包管理优化
- [ ] 委外订单显示所有订单
- [ ] 我的委外只显示当前用户负责的订单
- [ ] 新增"内部负责人"列

### 审批流驳回
- [ ] 驳回时必填驳回原因
- [ ] 显示驳回状态和原因
- [ ] 重新提交前验证是否修改

### 业务单位审批
- [ ] 管理员可审批通过/驳回
- [ ] 非管理员无法审批
- [ ] 驳回后可重新提交

### 报价/合同/委托关系
- [ ] 报价单直接生成委托单
- [ ] 正确记录来源信息
- [ ] 原有流程仍可使用

### 报告时间列
- [ ] 咨询→报价→委托→任务数据继承
- [ ] 所有页面显示报告时间列
- [ ] 过期时间红色标记

---

**文档版本**: 1.0
**最后更新**: 2026-02-02
**总结者**: AI Assistant
